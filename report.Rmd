---
title: "Report: Australian Census Data"
subtitle: "ETC5513 Assignment 4: Star Wars"
author:
- familyname: Faizan
  othernames: Mohammed
  address: Monash University
  email: mfai0014@student.monash.edu
  correspondingauthor: true
  qualifications:  MBAt
- familyname: More
  othernames: Adarsh
  address: Monash University
  email: amor0060@student.monash.edu
  qualifications: MBAt
- familyname: LI
  othernames: Yanhui
  address: Monash University
  email: yli807@student.monash.edu
  correspondingauthor: true
  qualifications:  MBAt
department: Our consultancy - Star Wars\newline Mohammed Faizan &\newline Adarsh More&\newline Yanhui LI
organization: Monash University
bibliography: 
- reference.bib
- packages.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  bookdown::html_document2:
    template: monashreport2.tex
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: true
keep_md: true
---

```{r echo=FALSE, include=FALSE}
knitr::opts_chunk$set(fig.path = "Figures/", fig.align ="center",
                      out.width = "50%", echo = FALSE, 
                      messages = FALSE, 
                      warning = FALSE)
# Loading Libraries
library(tidyverse)
library(readr)
library(kableExtra)
library(tinytex)
library(bookdown)
library(naniar)
library(visdat)
library(citation)
library(knitr)
library(scales)
library(patchwork)
library(sf)
library(glue)
library(unglue)
library(sugarbag)
library(readxl)
library(plotly)
library(tidytext)
library(igraph)
library(ggraph)
```


```{r writing_packages_bibliographies}
knitr::write_bib(c(.packages()), "packages.bib")
```


```{r}
celldiscriptors <- read_excel(here::here("data/australian_census_data_2016/Metadata/Metadata_2016_GCP_DataPack.xlsx"), sheet=2, skip=10)
```


```{r}
data_path <- here::here("data/australian_census_data_2016/")
```


```{r}
data_path <- here::here("data/australian_census_data_2016/")
census_paths <- glue::glue(data_path, "/2016 Census GCP All Geographies for VIC/SA4/VIC/2016Census_G{number}{alpha}_VIC_SA4.csv", 
                         number = c("46","46","47","47","47","51","51","51","51","57","57", "52", "52", "52", "52", "58", "58"), alpha = c("A","B","A","B","C","A","B","C","D","A","B", "A","B","C","D", "A","B"))
```
```{r geopath}
geopath <- glue::glue(data_path, "/2016_SA4_shape/SA4_2016_AUST.shp")
sa4_codes<- read_csv(census_paths[2]) %>% 
                mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
                select(SA4_CODE_2016)
sa4_geomap <- read_sf(geopath) %>%
  right_join(sa4_codes, by=c("SA4_CODE16" = "SA4_CODE_2016"))
```


```{r}
ggplot(sa4_geomap) +
  geom_sf()
```


```{r g46read}
g46a<- read_csv(census_paths[1]) %>%
  select(-starts_with("P"), -contains("Tot"), -contains("nfd"), -contains("IDes")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{educationlevel=GradDip_and_GradCert}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=PGrad_Deg}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=BachDeg}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=AdvDip_and_Dip}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=Cert_III_IV}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=Cert_I_II}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=Lev_Edu_NS}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{educationlevel=Lev_Edu_NS|GradDip_and_GradCert|PGrad_Deg|BachDeg|AdvDip_and_Dip|Cert_III_IV|Cert_I_II}_{age_min=\\d+}ov"
                      
                      ),
                remove = FALSE) %>% 
  select(-category)
  
```


```{r}
g46a <- g46a %>% 
  mutate(afq_level =case_when(str_detect(educationlevel, "GradDip_and_GradCert") ~ "Level 8",
                            str_detect(educationlevel, "PGrad") ~ "Level 9",
                            str_detect(educationlevel, "BachDeg") ~ "Level 7",
                            str_detect(educationlevel, "AdvDip_and_Dip") ~ "Level 5 & 6",
                            str_detect(educationlevel, "Cert_III_IV") ~ "Level 3 & 4",
                            str_detect(educationlevel, "Cert_I_II") ~ "Level 1 & 2",
                            str_detect(educationlevel, "Cert_Levl_nfd") ~ "Level 3 & 4",
                            str_detect(educationlevel, "Lev_Edu_IDes") ~ "Level Inadequately Described",
                            str_detect(educationlevel, "Lev_Edu_NS") ~ "Not Stated",
                            TRUE ~ educationlevel)) %>% 
  rename(count_edu_lvl = count)
```



```{r edu_gender, fig.cap = "Education level count by gender"}
ggplot(g46a, aes(x = reorder(afq_level,count_edu_lvl),
                      y = count_edu_lvl,
                      fill = sex)) +
         geom_col() +
         labs(x = "AQF levels",
              y = "number of observations",
              title = "Education level by gender") +
         scale_y_continuous(label=label_number())+
         coord_flip()
```


```{r}
g46a %>%
  ggplot(mapping = aes(x = fct_reorder(afq_level,count_edu_lvl), y = count_edu_lvl, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(afq_level,count_edu_lvl, sex), y = count_edu_lvl, fill = sex)) +
  labs(title = "Population Share of education level", y = "Number of students") +
  scale_y_continuous(label=label_number()) +
  coord_flip()
```


```{r popareaedu, fig.cap="Population distribution of education level"}
popareaedu <- g46a %>%
  group_by(SA4_CODE_2016, afq_level) %>%
  summarise(count_eduarea = sum(count_edu_lvl)) %>%
  ungroup()
popareaedumax <- popareaedu %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_eduarea) %>%
  arrange(SA4_CODE_2016)
popareaedumax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=afq_level)) +
  geom_sf_text(aes(geometry= geometry,label=afq_level, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
```

```{r}
g46redundantage <-  g46a[rep(rownames(g46a), g46a$count_edu_lvl), ]
ageeducount <- g46redundantage %>%
  ggplot(mapping = aes(x = age_min, y = afq_level)) +
  geom_count() +
  labs(title = "Population: Education level and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(ageeducount)
```


```{r bestedu, fig.cap="Best education level of each region"}
bestedu <- popareaedu %>% 
  select(1:3) %>%
  group_by(afq_level) %>%
  slice_max(count_eduarea) %>%
  arrange(SA4_CODE_2016)
bestedu %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder_within(afq_level,count_eduarea, SA4_CODE_2016), y = count_eduarea, fill = afq_level)) +
  labs(title = "Region and Best education level", 
       x = "Fields with region code",
       y = "Number of Students") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```



```{r}
g47 <- map_dfr(census_paths[3:4], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot"), -contains("InadDes")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{field=(Mgnt_Com|Society_Cult|Fd_Hosp_Psnl_Svcs|MixFld_Prgm|FldStd_NS|NatPhyl_Scn|InfoTech|Eng_RelTec|ArchtBldng|Ag_Envir_Rltd_Sts|Health|Educ|Creative_Arts)}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{field=(Mgnt_Com|Society_Cult|Fd_Hosp_Psnl_Svcs|MixFld_Prgm|FldStd_NS|NatPhyl_Scn|InfoTech|Eng_RelTec|ArchtBldng|Ag_Envir_Rltd_Sts|Health|Educ|Creative_Arts)}_{age_min=\\d+}ov",
                      "{sex=[MF]}_{field=(Mgnt_Com|Society_Cult|Fd_Hosp_Psnl_Svcs|MixFld_Prgm|FldStd_NS|N{atPhyl_Scn|InfoTech|Eng_RelTec|ArchtBldng|Ag_Envir_Rltd_Sts|Health|Educ|Creative_Arts)}_{age_min=\\d+}_years_and_over"
                      
                      ),
                remove = FALSE)
})
```


```{r}
g47 <- g47 %>% 
  mutate(field =case_when(
    str_detect(field, "NatPhyl_Scn") ~ "Natural_and_Physical_Sciences",
                            str_detect(field, "InfoTech") ~ "Information_Technology",
                            str_detect(field, "Eng_RelTec") ~ "Engineering_and_Technologies",
                            str_detect(field, "ArchtBldng") ~ "Architecture_and_Building",
                            str_detect(field, "Ag_Envir_Rltd_Sts") ~ "Agriculture_Environment",
                            str_detect(field, "Health") ~ "Health",
                            str_detect(field, "Educ") ~ "Education",
                            str_detect(field, "Mgnt_Com") ~ "Management_and_Commerce",
                            str_detect(field, "Society_Cult") ~ "Society_and_Culture",
                            str_detect(field, "Creative_Arts") ~ "Creative_Arts",
                            str_detect(field, "Fd_Hosp_Psnl_Svcs") ~ "Food_Hospitality_and_Personal_Services",str_detect(field, "MixFld_Prgm") ~ "Mixed_Field_Programmes",
                            str_detect(field, "FldStd_NS") ~ "Not Stated",
                            TRUE ~ field))  %>%
  select(-category) %>%
  rename(count_field = count)
```


```{r}
ggplot(g47, aes(x = reorder(field,count_field),
                      y = count_field,
                      fill = sex)) +
         geom_col() +
         labs(x = "Field",
              y = "number of observations",
              title = "Field by gender") +
  scale_y_continuous(label=label_number()) +
  coord_flip()
```

```{r}
ggplot(g47, aes(x = reorder_within(field,count_field,sex),
                      y = count_field,
                      fill = sex)) +
         geom_col() +
         labs(x = "Field",
              y = "number of observations",
              title = "Field by gender") +
  scale_y_continuous(label=label_number()) +
  coord_flip()
```


```{r popareafield, fig.cap="Population distribution of field"}
popareafield <- g47 %>%
  group_by(SA4_CODE_2016, field) %>%
  summarise(count_fieldarea = sum(count_field)) %>%
  ungroup()
popareafieldmax <- popareafield %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_fieldarea) %>%
  arrange(SA4_CODE_2016)
popareafieldmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=field)) +
  geom_sf_text(aes(geometry= geometry,label=field, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
```


```{r}
g47redundantage <-  g47[rep(rownames(g47), g47$count_field), ]
agefieldcount <- g47redundantage %>%
  ggplot(mapping = aes(x = age_min, y = field)) +
  geom_count() +
  labs(title = "Population: Field and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(agefieldcount)
```

```{r bestfield, fig.cap="Best field of each region"}
bestfield <- popareafield %>% 
  select(1:3) %>%
  group_by(field) %>%
  slice_max(count_fieldarea) %>%
  arrange(SA4_CODE_2016)
bestfield %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder_within(field,count_fieldarea, SA4_CODE_2016), y = count_fieldarea, fill = field)) +
  labs(title = "Region and Best Field", 
       x = "Fields with region code",
       y = "Number of Students") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```

```{r}
g51 <- map_dfr(census_paths[6:8], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{industry=(Ag_For_Fshg|Mining|Manufact|El_Gas_Wt_Waste|Constru|WhlesaleTde|RetTde|Accom_food|Trans_post_wrehsg|Info_media_teleco|Fin_Insur|RtnHir_REst|Pro_scien_tec|Admin_supp|Public_admin_sfty|Educ_trng|HlthCare_SocAs|Art_recn|Oth_scs|ID_NS)}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{industry=(Ag_For_Fshg|Mining|Manufact|El_Gas_Wt_Waste|Constru|WhlesaleTde|RetTde|Accom_food|Trans_post_wrehsg|Info_media_teleco|Fin_Insur|RtnHir_REst|Pro_scien_tec|Admin_supp|Public_admin_sfty|Educ_trng|HlthCare_SocAs|Art_recn|Oth_scs|ID_NS)}_{age_min=\\d+}ov"
                     ),
                remove = FALSE)
})
```
```{r}
g51 <- g51 %>% 
  mutate(industry =case_when(
                            str_detect(industry, "Ag_For_Fshg") ~ "Agriculture_forestry_and_fishing",
                            str_detect(industry, "Manufact") ~ "Manufacturing",
                            str_detect(industry, "El_Gas_Wt_Waste") ~ "Electricity_gas_water_and_waste_service",
                            str_detect(industry, "Constru") ~ "Construction",
                            str_detect(industry, "Ag_Envir_Rltd_Sts") ~ "Agriculture_Environment",
                            str_detect(industry, "WhlesaleTde") ~ "Wholesale_trade",
                            str_detect(industry, "RetTde") ~ "Retail_trade",
                            str_detect(industry, "Accom_food") ~ "Accommodation_and_food_services",
                            str_detect(industry, "Trans_post_wrehsg") ~ "Transport_postal_and_warehousing",
                            str_detect(industry, "Info_media_teleco") ~ "Information_media_and_telecommunications",
                            str_detect(industry, "Fin_Insur") ~ "Financial_and_insurance_services",
                            str_detect(industry, "RtnHir_REst") ~ "Rental_hiring_and_real_estate_services",
                            str_detect(industry, "Pro_scien_tec") ~ "Professional_scientific_and_technical_services",
                            str_detect(industry, "Admin_supp") ~ "Administrative_and_support_services",
                            str_detect(industry, "Public_admin_sfty") ~ "Public_administration_and_safety",
                            str_detect(industry, "Educ_trng") ~ "Education_and_training",
                            str_detect(industry, "HlthCare_SocAs") ~ "Health_care_and_social_assistance",
                            str_detect(industry, "Art_recn") ~ "Arts_and_recreation_services",
                            str_detect(industry, "Oth_scs") ~ "Other_services",
                            str_detect(industry, "ID_NS") ~ "Not Stated",
                            TRUE ~ industry))  %>%
  select(-category) %>%
  rename(count_industry = count)
```
```{r}
g57 <- map_dfr(census_paths[10], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}{age_min=\\d+}_{age_max=\\d+}_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}",
                      "{sex=[MF]}{age_min=\\d+}ov_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}",
                      "{sex=[MF]}{age_min=\\d+}_ov_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}"
                      ),  
                remove = FALSE)  
})
```
```{r}
g57 <- g57 %>% 
  mutate(occupation =case_when(
                            str_detect(occupation, "TechnicTrades_W") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "TechnicTrades_Wrs") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "CommunPersnlSvc") ~ "Community_and_personal_service_workers",
                            str_detect(occupation, "ClericalAdminis_W") ~ "Clerical_and_administrative_workers",
                            str_detect(occupation, "Sales_W") ~ "Sales_workers",
                            str_detect(occupation, "Mach_oper_drivers") ~ "Machinery_operators_and_drivers",
                            str_detect(occupation, "Occu_ID_NS") ~ "Not Stated",
                            TRUE ~ occupation))  %>%
  select(-category) %>%
  rename(count_occupation = count)
```

```{r cases-distribution, message=FALSE,warning=FALSE}
g51 %>% 
  group_by(industry) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = count_industry)) +
  labs(title = "Population Distribution by Industry of Employment", x = "Number of Industries", y = "Count")
#4000 records with near to 500 count_industry values.
```



```{r , fig.cap=""}
g51 %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder(industry,count_industry), y = count_industry, fill = sex)) +
  labs(title = "Population Share of Industries", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
g51 %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(industry,count_industry, sex), y = count_industry, fill = sex)) +
  labs(title = "Population Share of Industries", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
```
```{r}
vicpopulation <- g51 %>%
  group_by(SA4_CODE_2016) %>%
  summarise(population = sum(count_industry)) %>%
  ungroup()
population <- vicpopulation %>%
  summarise(population=sum(population))
vicpopulation <- g51 %>%
  group_by(SA4_CODE_2016, sex) %>%
  summarise(population = sum(count_industry)) %>%
  ungroup(sex) %>%
  pivot_wider(names_from = sex,
              values_from = population) %>%
  rename(malepopulation = M,
         femalepopulation = `F`) %>%
  full_join(vicpopulation)
```
```{r}
vicpopulation %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=population)) +
  geom_sf_text(aes(geometry= geometry,label=SA4_CODE_2016, colour="white"), 
               check_overlap=TRUE)+
  theme_void() 
```
```{r}
g51 %>%
  pivot_wider(names_from = sex,
              values_from = count_industry) %>%
  ggplot(mapping = aes(x = M, y = `F`, colour = industry)) +
  geom_point() +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population") +
  scale_y_continuous(label=label_number()) +
  scale_x_continuous(label=label_number()) +
  theme(legend.position = "bottom")
```
```{r}
g51indmfnest <- g51 %>%
  pivot_wider(names_from = sex,
              values_from = count_industry) %>%
  select(industry, `F`, M ) %>%
  group_by(industry) %>%
  nest() %>%
  mutate(model = map(data, lm)) %>%
  mutate(aug = map(model, broomstick::augment)) %>%
  unnest(aug)
mvf <- ggplot(g51indmfnest,
       aes(x = M)) +
# index represent splitting value,
#geom_point(aes(y = `F`, colour = industry, aplha=0)) +
geom_line(aes(y = .fitted, colour = industry)) +
  theme(legend.position = "bottom")  +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population")
  # geom_text(aes(y = .fitted,label=industry, colour="white"), 
  #              check_overlap=TRUE)
ggplotly(mvf) %>%
  hide_legend()
```

```{r}
g51redundantage <-  g51[rep(rownames(g51), g51$count_industry), ]
ageindcount <- g51redundantage %>%
  ggplot(mapping = aes(x = age_min, y = industry)) +
  geom_count() +
  labs(title = "Population: Industries and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(ageindcount)
```
```{r agedistribution}
g51redundantage %>%
  ggplot()+
  geom_density(mapping = aes( x = as.numeric(age_min),
                              colour = sex, 
                              alpha = 0.5)) +
  scale_x_continuous()
```

```{r}
popindage <- g51 %>%
  group_by(industry, age_min) %>%
  summarise(count_indage = sum(count_industry)) %>%
  ungroup()
nodes <- data.frame(node = unique(popindage$industry),
                    category = "industry") %>%
  full_join(data.frame(node = unique(popindage$age_min),
                    category = "age"))
popindage <- popindage[,c(1,2,3,1)]
networkindage <-   graph_from_data_frame(d=popindage,directed = TRUE, vertices = nodes)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
set.seed(122)
networkindage %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_indage,edge_width = count_indage,edge_color = industry),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```


```{r }
popindarea <- g51 %>%
  group_by(SA4_CODE_2016, industry) %>%
  summarise(count_indarea = sum(count_industry)) %>%
  ungroup()
nodesarea <- data.frame(node = unique(popindarea$SA4_CODE_2016),
                    category = "area") %>%
  full_join(data.frame(node = unique(popindarea$industry),
                    category = "industry"))
popindarea <- popindarea[,c(1,2,3,2)]
networkindarea <-   graph_from_data_frame(d=popindarea,directed = TRUE, vertices = nodesarea)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
networkindarea %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_indarea,edge_width = count_indarea,edge_color = industry),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```

```{r popindarea, fig.cap="Spatial Industry Distribution"}
popindareamax <- popindarea %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_indarea)
popindareamax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=industry)) +
 # geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")
#major industry in cbd is helthcare
#major industry in country side is agriculture
```

```{r popareaind, fig.cap=""}
popindarea <- g51 %>%
  group_by(SA4_CODE_2016, industry) %>%
  summarise(count_indarea = sum(count_industry)) %>%
  ungroup()
popareaindmax <- popindarea %>% 
  select(1:3) %>%
  group_by(industry) %>%
  slice_max(count_indarea) %>%
  arrange(SA4_CODE_2016)
popareaindmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=industry)) +
  geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
popareaindmax %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(industry,count_indarea, SA4_CODE_2016), y = count_indarea, fill = industry)) +
  labs(title = "Region and Best Industry", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```

```{r , fig.cap=""}
g57 %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occupation), y = count_occupation, fill = sex)) +
  geom_col(mapping = aes(x = reorder(occupation, count_occupation), y = count_occupation, fill = sex)) +
  labs(title = "Population Share of Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
g57 %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occupation), y = count_occupation, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occupation, sex), y = count_occupation, fill = sex)) +
  labs(title = "Population Share of Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
```

```{r}
g57 %>%
  pivot_wider(names_from = sex,
              values_from = count_occupation) %>%
  ggplot(mapping = aes(x = M, y = `F`, colour = occupation)) +
  geom_point() +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population") +
  scale_y_continuous(label=label_number()) +
  scale_x_continuous(label=label_number()) +
  theme(legend.position = "bottom")
```
```{r}
g57occmfnest <- g57 %>%
  pivot_wider(names_from = sex,
              values_from = count_occupation) %>%
  select(occupation, `F`, M ) %>%
  group_by(occupation) %>%
  nest() %>%
  mutate(model = map(data, lm)) %>%
  mutate(aug = map(model, broomstick::augment)) %>%
  unnest(aug)
mvfocc <- ggplot(g57occmfnest,
       aes(x = M)) +
# index represent splitting value,
#geom_point(aes(y = `F`, colour = industry, aplha=0)) +
geom_line(aes(y = .fitted, colour = occupation)) +
  theme(legend.position = "bottom")  +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population")
  # geom_text(aes(y = .fitted,label=industry, colour="white"), 
  #              check_overlap=TRUE)
ggplotly(mvfocc) %>%
  hide_legend()
```

```{r}
g57redundantage <-  g57[rep(rownames(g57), g57$count_occupation), ]
ageocccount <- g57redundantage %>%
  ggplot(mapping = aes(x = age_min, y = occupation)) +
  geom_count() +
  labs(title = "Population: Occupation and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(ageocccount)
```
```{r agedistributiong57}
g57redundantage %>%
  ggplot()+
  geom_density(mapping = aes( x = as.numeric(age_min),
                              colour = sex, 
                              alpha = 0.5)) +
  scale_x_continuous()
```

```{r}
popoccage <- g57 %>%
  group_by(occupation, age_min) %>%
  summarise(count_occage = sum(count_occupation)) %>%
  ungroup()
nodesocc <- data.frame(node = unique(popoccage$occupation),
                    category = "occupation") %>%
  full_join(data.frame(node = unique(popindage$age_min),
                    category = "age"))
popoccage <- popoccage[,c(1,2,3,1)]
networkoccage <-   graph_from_data_frame(d=popoccage,directed = TRUE, vertices = nodesocc)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
set.seed(122)
networkoccage %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_occage,edge_width = count_occage,edge_color = occupation),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```


```{r }
popareaocc <- g57 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occarea = sum(count_occupation)) %>%
  ungroup()
nodesareaocc <- data.frame(node = unique(popareaocc$SA4_CODE_2016),
                    category = "area") %>%
  full_join(data.frame(node = unique(popareaocc$occupation),
                    category = "occupation"))
popareaocc <- popareaocc[,c(1,2,3,2)]
networkoccarea <-   graph_from_data_frame(d=popareaocc,directed = TRUE, vertices = nodesareaocc)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
networkoccarea %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_occarea,edge_width = count_occarea,edge_color = occupation),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```

```{r popoccarea, fig.cap="Spatial Industry Distribution"}
popoccareamax <- popareaocc %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_occarea)
popoccareamax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
 # geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")

```

```{r popareaocc, fig.cap=""}
popoccarea <- g57 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occarea = sum(count_occupation)) %>%
  ungroup()
popareaoccmax <- popoccarea %>% 
  select(1:3) %>%
  group_by(occupation) %>%
  slice_max(count_occarea) %>%
  arrange(SA4_CODE_2016)
popareaoccmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
  geom_sf_text(aes(geometry= geometry,label=occupation, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
popareaoccmax %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occarea), y = count_occarea, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occarea, SA4_CODE_2016), y = count_occarea, fill = occupation)) +
  labs(title = "Region and Best Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```



```{r}
g51 <- map_dfr(census_paths[6:8], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{industry=(Ag_For_Fshg|Mining|Manufact|El_Gas_Wt_Waste|Constru|WhlesaleTde|RetTde|Accom_food|Trans_post_wrehsg|Info_media_teleco|Fin_Insur|RtnHir_REst|Pro_scien_tec|Admin_supp|Public_admin_sfty|Educ_trng|HlthCare_SocAs|Art_recn|Oth_scs|ID_NS)}_{age_min=\\d+}_{age_max=\\d+}",
                      "{sex=[MF]}_{industry=(Ag_For_Fshg|Mining|Manufact|El_Gas_Wt_Waste|Constru|WhlesaleTde|RetTde|Accom_food|Trans_post_wrehsg|Info_media_teleco|Fin_Insur|RtnHir_REst|Pro_scien_tec|Admin_supp|Public_admin_sfty|Educ_trng|HlthCare_SocAs|Art_recn|Oth_scs|ID_NS)}_{age_min=\\d+}ov"
                     ),
                remove = FALSE)
})
```
```{r}
g51 <- g51 %>% 
  mutate(industry =case_when(
                            str_detect(industry, "Ag_For_Fshg") ~ "Agriculture_forestry_and_fishing",
                            str_detect(industry, "Manufact") ~ "Manufacturing",
                            str_detect(industry, "El_Gas_Wt_Waste") ~ "Electricity_gas_water_and_waste_service",
                            str_detect(industry, "Constru") ~ "Construction",
                            str_detect(industry, "Ag_Envir_Rltd_Sts") ~ "Agriculture_Environment",
                            str_detect(industry, "WhlesaleTde") ~ "Wholesale_trade",
                            str_detect(industry, "RetTde") ~ "Retail_trade",
                            str_detect(industry, "Accom_food") ~ "Accommodation_and_food_services",
                            str_detect(industry, "Trans_post_wrehsg") ~ "Transport_postal_and_warehousing",
                            str_detect(industry, "Info_media_teleco") ~ "Information_media_and_telecommunications",
                            str_detect(industry, "Fin_Insur") ~ "Financial_and_insurance_services",
                            str_detect(industry, "RtnHir_REst") ~ "Rental_hiring_and_real_estate_services",
                            str_detect(industry, "Pro_scien_tec") ~ "Professional_scientific_and_technical_services",
                            str_detect(industry, "Admin_supp") ~ "Administrative_and_support_services",
                            str_detect(industry, "Public_admin_sfty") ~ "Public_administration_and_safety",
                            str_detect(industry, "Educ_trng") ~ "Education_and_training",
                            str_detect(industry, "HlthCare_SocAs") ~ "Health_care_and_social_assistance",
                            str_detect(industry, "Art_recn") ~ "Arts_and_recreation_services",
                            str_detect(industry, "Oth_scs") ~ "Other_services",
                            str_detect(industry, "ID_NS") ~ "Not Stated",
                            TRUE ~ industry))  %>%
  select(-category) %>%
  rename(count_industry = count)
```
```{r}
g57 <- map_dfr(census_paths[10], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}{age_min=\\d+}_{age_max=\\d+}_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}",
                      "{sex=[MF]}{age_min=\\d+}ov_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}",
                      "{sex=[MF]}{age_min=\\d+}_ov_{occupation=(Managers|Professionals|TechnicTrades_Wrs|CommunPersnlSvc_W|ClericalAdminis_W|Sales_W|Mach_oper_drivers|Labourers|Occu_ID_NS|TechnicTrades_W)}"
                      ),  
                remove = FALSE)  
})
```
```{r}
g57 <- g57 %>% 
  mutate(occupation =case_when(
                            str_detect(occupation, "TechnicTrades_W") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "TechnicTrades_Wrs") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "CommunPersnlSvc") ~ "Community_and_personal_service_workers",
                            str_detect(occupation, "ClericalAdminis_W") ~ "Clerical_and_administrative_workers",
                            str_detect(occupation, "Sales_W") ~ "Sales_workers",
                            str_detect(occupation, "Mach_oper_drivers") ~ "Machinery_operators_and_drivers",
                            str_detect(occupation, "Occu_ID_NS") ~ "Not Stated",
                            TRUE ~ occupation))  %>%
  select(-category) %>%
  rename(count_occupation = count)
```

```{r cases-distribution, message=FALSE,warning=FALSE}
g51 %>% 
  group_by(industry) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = count_industry)) +
  labs(title = "Population Distribution by Industry of Employment", x = "Number of Industries", y = "Count")
#4000 records with near to 500 count_industry values.
```



```{r , fig.cap=""}
g51 %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder(industry,count_industry), y = count_industry, fill = sex)) +
  labs(title = "Population Share of Industries", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
g51 %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(industry,count_industry, sex), y = count_industry, fill = sex)) +
  labs(title = "Population Share of Industries", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
```
```{r}
vicpopulation <- g51 %>%
  group_by(SA4_CODE_2016) %>%
  summarise(population = sum(count_industry)) %>%
  ungroup()
population <- vicpopulation %>%
  summarise(population=sum(population))
vicpopulation <- g51 %>%
  group_by(SA4_CODE_2016, sex) %>%
  summarise(population = sum(count_industry)) %>%
  ungroup(sex) %>%
  pivot_wider(names_from = sex,
              values_from = population) %>%
  rename(malepopulation = M,
         femalepopulation = `F`) %>%
  full_join(vicpopulation)
```
```{r}
vicpopulation %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=population)) +
  geom_sf_text(aes(geometry= geometry,label=SA4_CODE_2016, colour="white"), 
               check_overlap=TRUE)+
  theme_void() 
```
```{r}
g51 %>%
  pivot_wider(names_from = sex,
              values_from = count_industry) %>%
  ggplot(mapping = aes(x = M, y = `F`, colour = industry)) +
  geom_point() +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population") +
  scale_y_continuous(label=label_number()) +
  scale_x_continuous(label=label_number()) +
  theme(legend.position = "bottom")
```
```{r}
g51indmfnest <- g51 %>%
  pivot_wider(names_from = sex,
              values_from = count_industry) %>%
  select(industry, `F`, M ) %>%
  group_by(industry) %>%
  nest() %>%
  mutate(model = map(data, lm)) %>%
  mutate(aug = map(model, broomstick::augment)) %>%
  unnest(aug)
mvf <- ggplot(g51indmfnest,
       aes(x = M)) +
# index represent splitting value,
#geom_point(aes(y = `F`, colour = industry, aplha=0)) +
geom_line(aes(y = .fitted, colour = industry)) +
  theme(legend.position = "bottom")  +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population")
  # geom_text(aes(y = .fitted,label=industry, colour="white"), 
  #              check_overlap=TRUE)
ggplotly(mvf) %>%
  hide_legend()
```

```{r}
g51redundantage <-  g51[rep(rownames(g51), g51$count_industry), ]
ageindcount <- g51redundantage %>%
  ggplot(mapping = aes(x = age_min, y = industry)) +
  geom_count() +
  labs(title = "Population: Industries and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(ageindcount)
```
```{r agedistribution}
g51redundantage %>%
  ggplot()+
  geom_density(mapping = aes( x = as.numeric(age_min),
                              colour = sex, 
                              alpha = 0.5)) +
  scale_x_continuous()
```

```{r}
popindage <- g51 %>%
  group_by(industry, age_min) %>%
  summarise(count_indage = sum(count_industry)) %>%
  ungroup()
nodes <- data.frame(node = unique(popindage$industry),
                    category = "industry") %>%
  full_join(data.frame(node = unique(popindage$age_min),
                    category = "age"))
popindage <- popindage[,c(1,2,3,1)]
networkindage <-   graph_from_data_frame(d=popindage,directed = TRUE, vertices = nodes)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
set.seed(122)
networkindage %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_indage,edge_width = count_indage,edge_color = industry),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```


```{r }
popindarea <- g51 %>%
  group_by(SA4_CODE_2016, industry) %>%
  summarise(count_indarea = sum(count_industry)) %>%
  ungroup()
nodesarea <- data.frame(node = unique(popindarea$SA4_CODE_2016),
                    category = "area") %>%
  full_join(data.frame(node = unique(popindarea$industry),
                    category = "industry"))
popindarea <- popindarea[,c(1,2,3,2)]
networkindarea <-   graph_from_data_frame(d=popindarea,directed = TRUE, vertices = nodesarea)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
networkindarea %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_indarea,edge_width = count_indarea,edge_color = industry),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```

```{r popindarea, fig.cap="Spatial Industry Distribution"}
popindareamax <- popindarea %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_indarea)
popindareamax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=industry)) +
 # geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")
#major industry in cbd is helthcare
#major industry in country side is agriculture
```

```{r popareaind, fig.cap=""}
popindarea <- g51 %>%
  group_by(SA4_CODE_2016, industry) %>%
  summarise(count_indarea = sum(count_industry)) %>%
  ungroup()
popareaindmax <- popindarea %>% 
  select(1:3) %>%
  group_by(industry) %>%
  slice_max(count_indarea) %>%
  arrange(SA4_CODE_2016)
popareaindmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=industry)) +
  geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
popareaindmax %>%
  ggplot(mapping = aes(x = fct_reorder(industry,count_industry), y = count_industry, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(industry,count_indarea, SA4_CODE_2016), y = count_indarea, fill = industry)) +
  labs(title = "Region and Best Industry", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```

```{r , fig.cap=""}
g57 %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occupation), y = count_occupation, fill = sex)) +
  geom_col(mapping = aes(x = reorder(occupation, count_occupation), y = count_occupation, fill = sex)) +
  labs(title = "Population Share of Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
g57 %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occupation), y = count_occupation, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occupation, sex), y = count_occupation, fill = sex)) +
  labs(title = "Population Share of Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip() 
```

```{r}
g57 %>%
  pivot_wider(names_from = sex,
              values_from = count_occupation) %>%
  ggplot(mapping = aes(x = M, y = `F`, colour = occupation)) +
  geom_point() +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population") +
  scale_y_continuous(label=label_number()) +
  scale_x_continuous(label=label_number()) +
  theme(legend.position = "bottom")
```
```{r}
g57occmfnest <- g57 %>%
  pivot_wider(names_from = sex,
              values_from = count_occupation) %>%
  select(occupation, `F`, M ) %>%
  group_by(occupation) %>%
  nest() %>%
  mutate(model = map(data, lm)) %>%
  mutate(aug = map(model, broomstick::augment)) %>%
  unnest(aug)
mvfocc <- ggplot(g57occmfnest,
       aes(x = M)) +
# index represent splitting value,
#geom_point(aes(y = `F`, colour = industry, aplha=0)) +
geom_line(aes(y = .fitted, colour = occupation)) +
  theme(legend.position = "bottom")  +
  labs(title = "Population: Male vs Female", 
       x = "Male Population",
       y= "Female Population")
  # geom_text(aes(y = .fitted,label=industry, colour="white"), 
  #              check_overlap=TRUE)
ggplotly(mvfocc) %>%
  hide_legend()
```

```{r}
g57redundantage <-  g57[rep(rownames(g57), g57$count_occupation), ]
ageocccount <- g57redundantage %>%
  ggplot(mapping = aes(x = age_min, y = occupation)) +
  geom_count() +
  labs(title = "Population: Occupation and Age", x = "Age") +
  theme(axis.title.y = element_blank())
ggplotly(ageocccount)
```
```{r agedistributiong57}
g57redundantage %>%
  ggplot()+
  geom_density(mapping = aes( x = as.numeric(age_min),
                              colour = sex, 
                              alpha = 0.5)) +
  scale_x_continuous()
```

```{r}
popoccage <- g57 %>%
  group_by(occupation, age_min) %>%
  summarise(count_occage = sum(count_occupation)) %>%
  ungroup()
nodesocc <- data.frame(node = unique(popoccage$occupation),
                    category = "occupation") %>%
  full_join(data.frame(node = unique(popindage$age_min),
                    category = "age"))
popoccage <- popoccage[,c(1,2,3,1)]
networkoccage <-   graph_from_data_frame(d=popoccage,directed = TRUE, vertices = nodesocc)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
set.seed(122)
networkoccage %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_occage,edge_width = count_occage,edge_color = occupation),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```


```{r }
popareaocc <- g57 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occarea = sum(count_occupation)) %>%
  ungroup()
nodesareaocc <- data.frame(node = unique(popareaocc$SA4_CODE_2016),
                    category = "area") %>%
  full_join(data.frame(node = unique(popareaocc$occupation),
                    category = "occupation"))
popareaocc <- popareaocc[,c(1,2,3,2)]
networkoccarea <-   graph_from_data_frame(d=popareaocc,directed = TRUE, vertices = nodesareaocc)
a <- grid::arrow(type = "closed", length = unit(0.2,"inches"))
networkoccarea %>%
  ggraph(layout = "stress") +
  geom_edge_link2(aes(edge_alpha = count_occarea,edge_width = count_occarea,edge_color = occupation),arrow = a) +
  geom_node_point(aes(size = 2, colour =category) )+
  geom_node_text(aes(label = name), repel = TRUE,  point.padding = unit(0.15, "lines")) +
theme_void() +
  theme(legend.position = "none")
```

```{r popoccarea, fig.cap="Spatial Industry Distribution"}
popoccareamax <- popareaocc %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_occarea)
popoccareamax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
 # geom_sf_text(aes(geometry= geometry,label=industry, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")
#major industry in cbd is helthcare
#major industry in country side is agriculture
```

```{r popareaocc, fig.cap=""}
popoccarea <- g57 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occarea = sum(count_occupation)) %>%
  ungroup()
popareaoccmax <- popoccarea %>% 
  select(1:3) %>%
  group_by(occupation) %>%
  slice_max(count_occarea) %>%
  arrange(SA4_CODE_2016)
popareaoccmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
  geom_sf_text(aes(geometry= geometry,label=occupation, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "none")
popareaoccmax %>%
  ggplot(mapping = aes(x = fct_reorder(occupation,count_occarea), y = count_occarea, fill = sex)) +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occarea, SA4_CODE_2016), y = count_occarea, fill = occupation)) +
  labs(title = "Region and Best Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```



```{r}
g52 <- map_dfr(census_paths[12:14], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}_{hr_max=\\d+}",
                      "{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}",
                      "{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}over"
                     ),
                remove = FALSE)
})
```
```{r}
g52 <- g52 %>% 
  mutate(industry =case_when(
                            str_detect(industry, "AgriForestFish") ~ "Agriculture_forestry_and_fishing",
                            str_detect(industry, "Min") ~ "Mining",
                            str_detect(industry, "Mnfg") ~ "Manufacturing",
                            str_detect(industry, "EGW_WS") ~ "Electricity_gas_water_and_waste_service",
                            str_detect(industry, "Cnstn") ~ "Construction",
                            str_detect(industry, "WTrade") ~ "Wholesale_trade",
                            str_detect(industry, "RTrade") ~ "Retail_trade",
                            str_detect(industry, "AccomFoodS") ~ "Accommodation_and_food_services",
                            str_detect(industry, "TransPostWhse") ~ "Transport_postal_and_warehousing",
                            str_detect(industry, "InfoMedTelecom") ~ "Information_media_and_telecommunications",
                            str_detect(industry, "FinInsurS") ~ "Financial_and_insurance_services",
                            str_detect(industry, "RentHirREserv") ~ "Rental_hiring_and_real_estate_services",
                            str_detect(industry, "ProScieTechServ") ~ "Professional_scientific_and_technical_services",
                            str_detect(industry, "AdminSupServ") ~ "Administrative_and_support_services",
                            str_detect(industry, "PubAdmiSafety") ~ "Public_administration_and_safety",
                            str_detect(industry, "EducTrain") ~ "Education_and_training",
                            str_detect(industry, "HealthCareSocA") ~ "Health_care_and_social_assistance",
                            str_detect(industry, "ArtRecServ") ~ "Arts_and_recreation_services",
                            str_detect(industry, "OthServ") ~ "Other_services",
                            str_detect(industry, "ID_NS") ~ "Not Stated",
                            TRUE ~ industry))  %>%
  select(-category) %>%
  rename(count_industry = count)
```
```{r}
g58 <- map_dfr(census_paths[16], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}_{hrs_max=\\d+}",
                      "{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}",
                      "{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}over"
                      ),  
                remove = FALSE)  
})
```
```{r}
g58 <- g58 %>% 
  mutate(occupation =case_when(
                            str_detect(occupation, "Mng") ~ "Manager",
                            str_detect(occupation, "Pro") ~ "Professionals",
                            str_detect(occupation, "TTW") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "TechnicTrades_Wrs") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "CPS") ~ "Community_and_personal_service_workers",
                            str_detect(occupation, "CA") ~ "Clerical_and_administrative_workers",
                            str_detect(occupation, "Sal") ~ "Sales_workers",
                            str_detect(occupation, "MOD") ~ "Machinery_operators_and_drivers",
                            str_detect(occupation, "ID_NS") ~ "Not Stated",
                            TRUE ~ occupation))  %>%
  select(-category) %>%
  rename(count_occupation = count)
```


```{r hr_plots, fig.show='hold', out.width="50%"}
p1 <- g52 %>% 
  mutate(hr_min = as.numeric(hr_min)) %>% 
  summarise(hr_min = sum(hr_min, na.rm = TRUE))
  ggplot(g52, 
           mapping = aes(x = hr_min,
                         y = count_industry,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Minimum Hours") +
           ylab("Count") +
           ggtitle("Min hours worked for Industries")
p1

p2 <- g52 %>% 
  mutate(hr_max = as.numeric(hr_max)) %>% 
  summarise(hr_max = sum(hr_max, na.rm = TRUE))
  ggplot(g52, 
           mapping = aes(x = hr_max,
                         y = count_industry,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
            xlab("Maximum Hours") +
            ylab("Count") +
           ggtitle("Max hours worked for Industries")
p2
```

It can be observed from fig \@ref(fig:hr_plots) that overall females worked more than men. However, as the number of work-hours increased men have worked more than women.


```{r ind_hrs}
g52redundanthrs <-  g52[rep(rownames(g52), g52$count_industry), ]


hrindcount <- g52redundanthrs %>%
  ggplot(mapping = aes(x = hr_min, y = industry)) +
  geom_count() +
  labs(title = "Population: Industries and hours", x = "Hours") +
  theme(axis.title.y = element_blank())

ggplotly(hrindcount)
```

It can be observed from fig \@ref(fig:ind_hrs) that industries like health care, education and training, construction and Professional and technical services have more working population as the working hours increased. Mining, electricity, gas, water and agriculture forestry and fishing showed low working population irrespective of work hours.


```{r hrs_plots, fig.show='hold', out.width="50%"}
p3 <- g58 %>% 
  mutate(hrs_min = as.numeric(hrs_min)) %>% 
  summarise(hrs_min = sum(hrs_min, na.rm = TRUE))
  ggplot(g58, 
           mapping = aes(x = hrs_min,
                         y = count_occupation,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Minimum Hours") +
           ylab("Count") +
           ggtitle("Min hours worked at Occupation")
          
p3

p4 <- g58 %>% 
  mutate(hrs_max = as.numeric(hrs_max)) %>% 
  summarise(hrs_max = sum(hrs_max, na.rm = TRUE))
  ggplot(g58, 
           mapping = aes(x = hrs_max,
                         y = count_occupation,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Maximum Hours") +
           ylab("Count") +
           ggtitle("Max hours worked at Occupation")
p4
```

It can be observed from fig \@ref(fig:hrs_plots) that overall females worked more than men at all occupations. Although, for maximum hours worked, as number of working-hours increased, the number of men and women remained the same.

```{r popareaoccupation, fig.cap=""}

popareaoccupation <- g58 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occupationarea = sum(count_occupation)) %>%
  ungroup()

popareaoccupationmax <- popareaoccupation %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_occupationarea) %>%
  arrange(SA4_CODE_2016)
popareaoccupationmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
  geom_sf_text(aes(geometry= geometry,label=occupation, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")
bestfield <- popareaoccupation %>% 
  select(1:3) %>%
  group_by(occupation) %>%
  slice_max(count_occupationarea) %>%
  arrange(SA4_CODE_2016)
	
bestfield %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occupationarea, SA4_CODE_2016), y = count_occupationarea, fill = occupation)) +
  labs(title = "Region and Best Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```


It can be observed from fig \@ref(fig:popareaoccupation) tha the most number of employees in the SA4 regions are employed in the occupations of Professionals, Managers and Technicians and trade workers. Professionals accounted for highest number of employees for region 206, while machinery operators and drivers accounted for the least number of employees for region 213 respectively.















