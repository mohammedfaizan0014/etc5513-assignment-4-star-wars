---
title: "Report: Australian Census Data"
subtitle: "ETC5513 Assignment 4: Star Wars"
author:
- familyname: Faizan
  othernames: Mohammed
  address: Monash University
  email: mfai0014@student.monash.edu
  correspondingauthor: true
  qualifications:  MBAt
- familyname: More
  othernames: Adarsh
  address: Monash University
  email: amor0060@student.monash.edu
  qualifications: MBAt
- familyname: LI
  othernames: Yanhui
  address: Monash University
  email: yli807@student.monash.edu
  correspondingauthor: true
  qualifications:  MBAt
department: Our consultancy - Star Wars\newline Mohammed Faizan &\newline Adarsh More&\newline Yanhui LI
organization: Monash University
bibliography: 
- references.bib
- packages.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  bookdown::html_document2:
    template: monashreport2.tex
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: true
keep_md: true
---

```{r echo=FALSE, include=FALSE}
knitr::opts_chunk$set(fig.path = "Figures/", fig.align ="center",
                      out.width = "50%", echo = FALSE, 
                      messages = FALSE, 
                      warning = FALSE)
# Loading Libraries
library(tidyverse)
library(readr)
library(kableExtra)
library(tinytex)
library(bookdown)
library(naniar)
library(visdat)
library(citation)
library(knitr)
library(scales)
library(patchwork)
library(sf)
library(glue)
library(unglue)
library(sugarbag)
library(readxl)
library(plotly)
library(tidytext)
```


```{r writing_packages_bibliographies}
knitr::write_bib(c(.packages()), "packages.bib")
```


```{r}
celldiscriptors <- read_excel(here::here("data/australian_census_data_2016/Metadata/Metadata_2016_GCP_DataPack.xlsx"), sheet=2, skip=10)
```


```{r}
data_path <- here::here("data/australian_census_data_2016/")
```


```{r}
data_path <- here::here("data/australian_census_data_2016/")
census_paths <- glue::glue(data_path, "/2016 Census GCP All Geographies for VIC/SA4/VIC/2016Census_G{number}{alpha}_VIC_SA4.csv", 
                         number = c("46","46","47","47","47","51","51","51","51","57","57", "52", "52", "52", "52", "58", "58"), alpha = c("A","B","A","B","C","A","B","C","D","A","B", "A","B","C","D", "A","B"))
```
```{r geopath, include=FALSE}
geopath <- glue::glue(data_path, "/2016_SA4_shape/SA4_2016_AUST.shp")
sa4_codes<- read_csv(census_paths[2]) %>% 
                mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
                select(SA4_CODE_2016)
sa4_geomap <- read_sf(geopath) %>%
  right_join(sa4_codes, by=c("SA4_CODE16" = "SA4_CODE_2016"))
```


```{r}
ggplot(sa4_geomap) +
  geom_sf()
```


```{r}
g52 <- map_dfr(census_paths[12:14], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}_{hr_max=\\d+}",
                      "{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}",
                      "{sex=[MF]}_{industry=(AgriForestFish|Min|Mnfg|EGW_WS|Cnstn|WTrade|RTrade|AccomFoodS|TransPostWhse|InfoMedTelecom|FinInsurS|RentHirREserv|ProScieTechServ|AdminSupServ|PubAdmiSafety|EducTrain|HealthCareSocA|ArtRecServ|OthServ|ID_NS)}_{hr_min=\\d+}over"
                     ),
                remove = FALSE)
})
```
```{r}
g52 <- g52 %>% 
  mutate(industry =case_when(
                            str_detect(industry, "AgriForestFish") ~ "Agriculture_forestry_and_fishing",
                            str_detect(industry, "Min") ~ "Mining",
                            str_detect(industry, "Mnfg") ~ "Manufacturing",
                            str_detect(industry, "EGW_WS") ~ "Electricity_gas_water_and_waste_service",
                            str_detect(industry, "Cnstn") ~ "Construction",
                            str_detect(industry, "WTrade") ~ "Wholesale_trade",
                            str_detect(industry, "RTrade") ~ "Retail_trade",
                            str_detect(industry, "AccomFoodS") ~ "Accommodation_and_food_services",
                            str_detect(industry, "TransPostWhse") ~ "Transport_postal_and_warehousing",
                            str_detect(industry, "InfoMedTelecom") ~ "Information_media_and_telecommunications",
                            str_detect(industry, "FinInsurS") ~ "Financial_and_insurance_services",
                            str_detect(industry, "RentHirREserv") ~ "Rental_hiring_and_real_estate_services",
                            str_detect(industry, "ProScieTechServ") ~ "Professional_scientific_and_technical_services",
                            str_detect(industry, "AdminSupServ") ~ "Administrative_and_support_services",
                            str_detect(industry, "PubAdmiSafety") ~ "Public_administration_and_safety",
                            str_detect(industry, "EducTrain") ~ "Education_and_training",
                            str_detect(industry, "HealthCareSocA") ~ "Health_care_and_social_assistance",
                            str_detect(industry, "ArtRecServ") ~ "Arts_and_recreation_services",
                            str_detect(industry, "OthServ") ~ "Other_services",
                            str_detect(industry, "ID_NS") ~ "Not Stated",
                            TRUE ~ industry))  %>%
  select(-category) %>%
  rename(count_industry = count)
```
```{r}
g58 <- map_dfr(census_paths[16], ~{
  df <- read_csv(.x) %>%
      select(-starts_with("P"), -contains("Tot")) %>%
            mutate(SA4_CODE_2016 = as.character(SA4_CODE_2016)) %>% 
  pivot_longer(cols = -c(SA4_CODE_2016),
                  names_to = "category",
                  values_to = "count") %>%
  unglue_unnest(category, 
                    c("{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}_{hrs_max=\\d+}",
                      "{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}",
                      "{sex=[MF]}_{occupation=(Mng|Pro|TTW|CPS|CA|Sal|MOD|Lab|ID_NS|)}_{hrs_min=\\d+}over"
                      ),  
                remove = FALSE)  
})
```
```{r}
g58 <- g58 %>% 
  mutate(occupation =case_when(
                            str_detect(occupation, "Mng") ~ "Manager",
                            str_detect(occupation, "Pro") ~ "Professionals",
                            str_detect(occupation, "TTW") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "TechnicTrades_Wrs") ~ "Technicians_and_trades_workers",
                            str_detect(occupation, "CPS") ~ "Community_and_personal_service_workers",
                            str_detect(occupation, "CA") ~ "Clerical_and_administrative_workers",
                            str_detect(occupation, "Sal") ~ "Sales_workers",
                            str_detect(occupation, "MOD") ~ "Machinery_operators_and_drivers",
                            str_detect(occupation, "ID_NS") ~ "Not Stated",
                            TRUE ~ occupation))  %>%
  select(-category) %>%
  rename(count_occupation = count)
```


```{r hr_plots, fig.show='hold', out.width="50%"}
p1 <- g52 %>% 
  mutate(hr_min = as.numeric(hr_min)) %>% 
  summarise(hr_min = sum(hr_min, na.rm = TRUE))
  ggplot(g52, 
           mapping = aes(x = hr_min,
                         y = count_industry,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Minimum Hours") +
           ylab("Count") +
           ggtitle("Min hours worked for Industries")
p1

p2 <- g52 %>% 
  mutate(hr_max = as.numeric(hr_max)) %>% 
  summarise(hr_max = sum(hr_max, na.rm = TRUE))
  ggplot(g52, 
           mapping = aes(x = hr_max,
                         y = count_industry,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
            xlab("Maximum Hours") +
            ylab("Count") +
           ggtitle("Max hours worked for Industries")
p2
```

It can be observed from fig \@ref(fig:hr_plots) that overall females worked more than men. However, as the number of work-hours increased men have worked more than women.


```{r ind_hrs}
g52redundanthrs <-  g52[rep(rownames(g52), g52$count_industry), ]


hrindcount <- g52redundanthrs %>%
  ggplot(mapping = aes(x = hr_min, y = industry)) +
  geom_count() +
  labs(title = "Population: Industries and hours", x = "Hours") +
  theme(axis.title.y = element_blank())

ggplotly(hrindcount)
```

It can be observed from fig \@ref(fig:ind_hrs) that industries like health care, education and training, construction and Professional and technical services have more working population as the working hours increased. Mining, electricity, gas, water and agriculture forestry and fishing showed low working population irrespective of work hours.


```{r hrs_plots, fig.show='hold', out.width="50%"}
p3 <- g58 %>% 
  mutate(hrs_min = as.numeric(hrs_min)) %>% 
  summarise(hrs_min = sum(hrs_min, na.rm = TRUE))
  ggplot(g58, 
           mapping = aes(x = hrs_min,
                         y = count_occupation,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Minimum Hours") +
           ylab("Count") +
           ggtitle("Min hours worked at Occupation")
          
p3

p4 <- g58 %>% 
  mutate(hrs_max = as.numeric(hrs_max)) %>% 
  summarise(hrs_max = sum(hrs_max, na.rm = TRUE))
  ggplot(g58, 
           mapping = aes(x = hrs_max,
                         y = count_occupation,
                         fill = sex)) +
           geom_bar(stat = "identity",
                            position = "dodge") +
           theme_bw() +
           xlab("Maximum Hours") +
           ylab("Count") +
           ggtitle("Max hours worked at Occupation")
p4
```

It can be observed from fig \@ref(fig:hrs_plots) that overall females worked more than men at all occupations. Although, for maximum hours worked, as number of working-hours increased, the number of men and women remained the same.

```{r popareaoccupation, fig.cap=""}

popareaoccupation <- g58 %>%
  group_by(SA4_CODE_2016, occupation) %>%
  summarise(count_occupationarea = sum(count_occupation)) %>%
  ungroup()

popareaoccupationmax <- popareaoccupation %>% 
  select(1:3) %>%
  group_by(SA4_CODE_2016) %>%
  slice_max(count_occupationarea) %>%
  arrange(SA4_CODE_2016)
popareaoccupationmax %>% 
  full_join(sa4_geomap, 
            by = c("SA4_CODE_2016"="SA4_CODE")) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry= geometry, fill=occupation)) +
  geom_sf_text(aes(geometry= geometry,label=occupation, colour="white"), check_overlap=TRUE)+
  theme_void() +
  theme(legend.position = "bottom")
bestfield <- popareaoccupation %>% 
  select(1:3) %>%
  group_by(occupation) %>%
  slice_max(count_occupationarea) %>%
  arrange(SA4_CODE_2016)
	
bestfield %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder_within(occupation,count_occupationarea, SA4_CODE_2016), y = count_occupationarea, fill = occupation)) +
  labs(title = "Region and Best Occupation", y = "Number of Employees") +
  scale_y_continuous(label=label_number()) +
  coord_flip()  +
  theme(legend.position = "none")
```


It can be observed from fig \@ref(fig:popareaoccupation) tha the most number of employees in the SA4 regions are employed in the occupations of Professionals, Managers and Technicians and trade workers. Professionals accounted for highest number of employees for region 206, while machinery operators and drivers accounted for the least number of employees for region 213 respectively.














